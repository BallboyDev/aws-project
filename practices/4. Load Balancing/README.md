# Load Balancing (부하 분산)
- 로드 밸런싱은 서버-클라이언트 환경에서 서버가 클라이언트 요청을 받아 처리하는 과정에서 발생하는 부하(연산 작업)에 대해 동일한 목적을 수행하는 다수의 서버에 분산 처리하는 기능이다.

## Amazon ELB
- ELB라는 Amazon EC2 인스턴스에서 운영 중인 애플리케이션, 마이크로 서비스 또는 컨테이너 서비스로 유입되는 트래픽을 자동 분산 처리하는 기술로, ELB는 여러 가용 영역에서 작동하여 애플리케이션 가용성을 향상시키고 HTTP, HTTPS, TCP, SSL 등 다양한 프로토콜을 지원한다. 사용자가 같은 인스턴스에서 세션을 유지할 수 있도록 지원한다.

## ELB 구성 요소
- 로드 밸런서
    - 여러 대의 EC2 인스턴스, IP 주소, 람다 등을 사용하여 트래픽 대상 그룹에 있는 인스턴스로 분산 시켜 애플리케이션의 가용성을 유지하는 역할을 한다.
    - 로드 밸런서는 사용자 요청을 받아 애플리케이션 서버로 전달하고, 애플리케이션 서버의 응답을 사용자에게 반환한다.

- 대상 그룹
    - 로드 밸런서에서 분산할 대상의 집합을 정의하는 구성요소이다. 대상 그룹의 인스턴스에 대해 정적 또는 동적으로 구성할 수 있으며, 라우팅 규칙에 따라 요청을 받아들일 대상 그룹을 선택한다.
    - 로드 밸런서는 대상 그룹에 포함된 대상들의 상태를 정기적으로 확인하여 장애 발생 대상을 자동으로 제외하고 정상적으로 동작하는 대상에만 요청을 전달한다.

- 리스너
    - 로드 밸런서에서 사용할 포트와 프로토콜을 설정하는 구성요소로 로드 밸런서에서 클라이언트 요청을 수신하고 해당 요청을 처리할 대상 그룹을 선택하는 역할을 한다.
    - 리스너는 로드 밸런서에 연결된 프로토콜과 포트를 사용하여 클라이언트 요청을 수신하고, 해당 요청을 대상 그룹으로 라우팅 한다.

~~~
// 로드 밸런스 구성도

인터넷/사용자
┃
리스너
┣━━━━━━┓
규칙    규칙
---    ---
동작    동작
┣━━━━━━┛
┃
대상 그룹
┃
┣━━━━━━━━┳━━━━━━━━┓
┃        ┃        ┃
target   target   target
~~~

## Amazon ELB 동작 방식
- ELB를 생성하면 설정한 가용 영역별로 로드 밸런서 노드가 생성되고 앞단에 리스너를 실행하고, 리스너는 요청에 대한 대상 그룹의 라우팅을 정의한다. 이에 따라 로드밸런서는 가용 영역에 속한 대상 그룹의 인스턴스로 트래픽을 전달한다.

## Amazon ELB 교차 영역 로드 밸런싱
- 여러 가용 영역에 걸쳐 있는 EC2 인스턴스나 컨테이너 등 대상을 더 효과적으로 로드 밸런싱 하는 기능으로, 이런 교차 영역 로드 밸런싱은 가용 영역별로 인스턴스 수량이 불균형하게 위치할 때 트래픽 비중을 보정할 수 있으며, 트래픽을 분산하는 기준이 가용 영역이 아닌 대상 그룹에 속한 자원을 기준으로 균일한 비중의 로드밸런싱을 수행한다.

## Amazon ELB 종류
### CLB (Classic Load Balancer)
- 1세대 로드 밸런서, 레거시 분류
- OSI 4계층(TCP)과 7계층(HTTP/HTTPS)에서 기본적인 로드 밸런싱을 수행
- 요청 내용과 상관없이 등록된 EC2 인스턴스에 트래픽을 순차적으로 분배하는 단순한 기능만 제공
- 사용 사례
    - 레거시 기능으로 권장되지 않음

### ALB (Application Load Balancer)
- 7계층 전용 로드 밸런서, 가장 널리 사용
- 콘텐츠 기반 라우팅 기능제공
    - 경로 기반
        - www.example.com/api는 A서버 그룹으로, www.example.com/images는 B서버 그룹으로 분배
    - 호스트 기반
        - blog.example.com은 C서버 그룹으로, shop.example.com은 D서버 그룹으로 분배
- 마이크로 서비스, 컨테이너(ECS, EKS) 기반 아키텍처에 최적화
- Lambda 함수 대상 호출 가능
- 사용 사례
    - 일반적인 웹 사이트 등 대부분의 현대적인 웹 애플리케이션 환경

### NLB (Network Load Balancer)
- 4계층(TCP, UDP, TLS) 전용 로드 밸런서
- 초고성능과 매우 낮은 지연 시간, 초당 수백만건의 요청을 처리 가능
- 로드 밸런서에 고정 IP 할당 가능
- 클라이언트의 출발지 IP 주소를 그대로 백엔드 서버에 전달
- 사용 사례
    - 성능이 중요한 TCP 트래픽 (온라인 게임, 실시간 스트리밍 서비스)
    - 예측 불가능한 급격한 트래픽 발생 서비스
    - IP 주소가 고정되어야 하는 외부 서비스와의 연동

### GWLB (Gateway Load Balancer)
- 3계층(네트워크 계층)과 4계층(전송 계층)에서 작동
- 일반적인 트래픽 분산이 아닌, 보안 장비나 네트워크 어플라이언스를 확장하기 위한 특수한 목적
- 모든 트래픽이 GWLB를 거쳐 방화벽, IDS/IPS 등 가상 어플라이언스 그룹으로 전달된 후, 다시 원래 목적지로 전달
- 사용 사례
    - 서드 파티 보안 업체의 방화벽, 딥 패킷 검사 시스템 등


## CloudFormation - 만드는 방법?
- CloudFormation은 IaC(Infrastructure as Code) 기반으로 AWS 인프라 리소스를 자동으로 생성하는 서비스이다.

### 구성요소
- 템플릿
    - AWS 인프라를 JSON 또는 YAML 형식의 코드로 정의하는 파일. 인프라의 속성, 관계, 종속성 등을 정의
- 스택
    - CloudFormation을 이용하여 생성하는 인프라의 집합
- 리소스
    - CloudFormation이 생성하는 AWS 리소스로 EC2 인스턴스, RDS 데이터베이스, S3 버킷 등이 포함된다.
- 파라미터
    - 스택을 생성할 때 전달할 수 있는 매개변수.
- 이벤트
    - CloudFormation 스택에서 발생하는 모든 이벤트 기록, 스택 생성, 변경, 삭제와 관련된 정보를 제공
- CloudFormation
    - 템플릿을 해석해서 스택을 생성하고, 정의된 AWS 인프라를 생성, 변경, 삭제


## 구현
- https://cloudneta-aws-book.s3.ap-northeast-2.amazonaws.com/chapter4/elblab.yaml